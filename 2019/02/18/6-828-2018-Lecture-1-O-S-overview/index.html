<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
    

    

    



    <meta charset="utf-8">
    
    
    
    <title>6.828-2018-Lecture-1:O/S overview | 泡壶Java | 浸透人生</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content="">
    <meta name="description" content="6.828 2018 Lecture 1: O/S overview16.828 2018 课时1:操作系统概述 Overview1概述  6.828 goals  Understand operating system design and implementation Hands-on experience by building small O/S123* 6.828 课程目标* 理解操作系">
<meta property="og:type" content="article">
<meta property="og:title" content="6.828-2018-Lecture-1:O&#x2F;S overview">
<meta property="og:url" content="http://andj.me/2019/02/18/6-828-2018-Lecture-1-O-S-overview/index.html">
<meta property="og:site_name" content="泡壶Java">
<meta property="og:description" content="6.828 2018 Lecture 1: O/S overview16.828 2018 课时1:操作系统概述 Overview1概述  6.828 goals  Understand operating system design and implementation Hands-on experience by building small O/S123* 6.828 课程目标* 理解操作系">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2019-09-07T05:20:46.738Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="6.828-2018-Lecture-1:O&#x2F;S overview">
<meta name="twitter:description" content="6.828 2018 Lecture 1: O/S overview16.828 2018 课时1:操作系统概述 Overview1概述  6.828 goals  Understand operating system design and implementation Hands-on experience by building small O/S123* 6.828 课程目标* 理解操作系">
    
        <link rel="alternate" type="application/atom+xml" title="泡壶Java" href="/atom.xml">
    
    <link rel="shortcut icon" href="/img/AnDJ.png">
    <link rel="stylesheet" href="//unpkg.com/hexo-theme-material-indigo@latest/css/style.css">
    <script>window.lazyScripts=[]</script>

    <!-- custom head -->
    

</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="hide">
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/img/brand.jpg)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/AnDJ.png">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">AnDJ</h5>
          <a href="mailto:aptx1376432332@gmail.com" title="aptx1376432332@gmail.com" class="mail">aptx1376432332@gmail.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/">
                <i class="icon icon-lg icon-home"></i>
                主页
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives">
                <i class="icon icon-lg icon-archives"></i>
                Archives
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags">
                <i class="icon icon-lg icon-tags"></i>
                Tags
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories">
                <i class="icon icon-lg icon-th-list"></i>
                Categories
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://github.com/An-DJ" target="_blank">
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="http://www.weibo.com/An_DJ" target="_blank">
                <i class="icon icon-lg icon-weibo"></i>
                Weibo
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/custom">
                <i class="icon icon-lg icon-link"></i>
                twitter
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">6.828-2018-Lecture-1:O/S overview</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="输入感兴趣的关键字">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">6.828-2018-Lecture-1:O/S overview</h1>
        <h5 class="subtitle">
            
                <time datetime="2019-02-17T18:44:13.000Z" itemprop="datePublished" class="page-time">
  2019-02-18
</time>


            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    

<article id="post-6-828-2018-Lecture-1-O-S-overview" class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">6.828-2018-Lecture-1:O/S overview</h1>
        <div class="post-meta">
            <time class="post-time" title="2019-02-17 18:44:13" datetime="2019-02-17T18:44:13.000Z" itemprop="datePublished">2019-02-17</time>

            


            
<span id="busuanzi_container_page_pv" title="文章总阅读量" style="display:none">
    <i class="icon icon-eye icon-pr"></i><span id="busuanzi_value_page_pv"></span>
</span>


        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <p>6.828 2018 Lecture 1: O/S overview<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">6.828 2018 课时1:操作系统概述</span><br></pre></td></tr></table></figure></p>
<p>Overview<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">概述</span><br></pre></td></tr></table></figure></p>
<ul>
<li><p>6.828 goals</p>
<ul>
<li>Understand operating system design and implementation</li>
<li>Hands-on experience by building small O/S<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* 6.828 课程目标</span><br><span class="line">* 理解操作系统的设计与实现</span><br><span class="line">* 通过构建小的操作系统来亲自动手实践</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>What is the purpose of an O/S?</p>
<ul>
<li>Support applications</li>
<li>Abstract the hardware for convenience and portability</li>
<li>Multiplex the hardware among multiple applications</li>
<li>Isolate applications in order to contain bugs</li>
<li>Allow sharing among applications</li>
<li>Provide high performance<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">* 操作系统的作用是什么?</span><br><span class="line">  * 支持应用运行</span><br><span class="line">  * 将硬件层抽象,提供方便和可移植性</span><br><span class="line">  * 在多个应用之间提供硬件资源复用</span><br><span class="line">  * 隔离多个应用,容许错误存在</span><br><span class="line">  * 允许应用之间共享资源</span><br><span class="line">  * 提供较高的性能</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>What is the O/S design approach?</p>
<ul>
<li>the small view: a h/w management library</li>
<li>the big view: physical machine -&gt; abstract one w/ better properties<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* 操作系统设计的方法是什么?</span><br><span class="line">  * 从小的角度来看:一个硬件管理库</span><br><span class="line">  * 从大的角度来看:物理机器到有着较好的性能的抽象单元的一个映射</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>Organization: layered picture<br> &emsp;h/w: CPU, mem, disk, &amp;c<br> &emsp;kernel services<br> &emsp;user applications: vi, gcc, &amp;c  </p>
<ul>
<li>we care a lot about the interfaces and internal kernel structure<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">* 操作系统的组织:分层图</span><br><span class="line">   硬件层:CPU(中央处理单元),内存,磁盘,等等</span><br><span class="line">   内核服务</span><br><span class="line">   用户应用层:vi,gcc,等等</span><br><span class="line">  * 我们比较关心接口和内部内核结构</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>What services does an O/S kernel typically provide?</p>
<ul>
<li>processes</li>
<li>memory allocation</li>
<li>file contents</li>
<li>directories and file names</li>
<li>security</li>
<li>many others: users, IPC, network, time, terminals<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">* 操作系统提供哪些有特点的服务?</span><br><span class="line">  * 进程</span><br><span class="line">  * 内存分配</span><br><span class="line">  * 文件内容</span><br><span class="line">  * 目录和文件名</span><br><span class="line">  * 安全</span><br><span class="line">  * 很多其他的服务:用户,IPC(进程间通信),网络,时间,终端.</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>What does an O/S abstraction look like?</p>
<ul>
<li>Applications see them only via system calls</li>
<li><p>Examples, from UNIX (e.g. Linux, OSX, FreeBSD):</p>
<pre><code>fd = open(&quot;out&quot;, 1);
write(fd, &quot;hello\n&quot;, 6);
pid = fork();
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">* 操作系统完成的抽象是什么样子的?</span><br><span class="line">  * 应用只能通过系统调用来访问它们</span><br><span class="line">  * 例如, 在UNIX下 (比如 Linux, OSX, FreeBSD):</span><br><span class="line"></span><br><span class="line">            fd = open(&quot;out&quot;, 1);</span><br><span class="line">            write(fd, &quot;hello\n&quot;, 6);</span><br><span class="line">            pid = fork();</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>Why is O/S design/implementation hard/interesting?</p>
<ul>
<li>the environment is unforgiving: quirky h/w, weak debugger</li>
<li>it must be efficient (thus low-level?)<br>…but abstract/portable (thus high-level?)</li>
<li>powerful (thus many features?)<br>…but simple (thus a few composable building blocks?)</li>
<li>features interact: <code>fd = open(); ...; fork()</code></li>
<li>behaviors interact: CPU priority vs memory allocator</li>
<li>open problems: security; performance; exploiting new hardware<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">* 为什么操作系统的设计和实现非常困难而且有意思?</span><br><span class="line">  * 不要忘记工作环境:古怪的硬件设备,功能弱小的调试工具</span><br><span class="line">  * 它必须得有效率(因此是底层?)</span><br><span class="line">	...但是也需要一定抽象和可移植(因此是上层?)</span><br><span class="line">  * 功能强大</span><br><span class="line">	...但是简单(因此有一些可组合的构建块?)</span><br><span class="line">  * 很有特点的交互方式: `fd = open(); ...; fork()`</span><br><span class="line">  * 行为交互方式: CPU优先级 vs 内存管理器</span><br><span class="line">  * 开放问题:安全,性能,开发新硬件</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>You’ll be glad you learned about operating systems if you…</p>
<ul>
<li>want to work on the above problems</li>
<li>care about what’s going on under the hood</li>
<li>have to build high-performance systems</li>
<li>need to diagnose bugs or security problems<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">* 学习操作系统你将会很开心,如果你...</span><br><span class="line">  * 想要从事于上述问题</span><br><span class="line">  * 关心在&quot;头巾&quot;下面到底发生了什么</span><br><span class="line">  * 必须构建高性能的系统</span><br><span class="line">  * 需要诊断错误(bugs)或安全问题</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<p>Class structure<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">课程结构</span><br></pre></td></tr></table></figure></p>
<ul>
<li><p>See web site: <a href="https://pdos.csail.mit.edu/6.828" target="_blank" rel="noopener">https://pdos.csail.mit.edu/6.828</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">具体查看网站: https://pdos.csail.mit.edu/6.828</span><br></pre></td></tr></table></figure>
</li>
<li><p>Lectures</p>
<ul>
<li>O/S ideas</li>
<li>detailed inspection of xv6, a traditional O/S</li>
<li>xv6 programming homework to motivate lectures</li>
<li>papers on some recent topics<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">* 课程讲座</span><br><span class="line">  * 操作系统相关概念</span><br><span class="line">  * 针对xv6, 一种经典的操作系统进行详细查看和学习</span><br><span class="line">  * 用xv6编程作业引导和推动课程讲座</span><br><span class="line">  * 近年一些相关主题的论文</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>Labs: JOS, a small O/S for x86 in an exokernel style</p>
<ul>
<li>you build it, 5 labs + final lab of your choice</li>
<li>kernel interface: expose hardware, but protect – few abstractions!</li>
<li>unprivileged user-level library: fork, exec, pipe, …</li>
<li>applications: file system, shell, ..</li>
<li>development environment: gcc, qemu</li>
<li>lab 1 is out<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">* 实验: JOS, 一个小的应用于x86架构的exokernel风格的操作系统</span><br><span class="line">  * 你来构建它,通过5个课内实验和一个你选择的最终实验完成</span><br><span class="line">  * 内核接口:暴露硬件,但是仍要保护起来--几乎没有抽象!</span><br><span class="line">  * 无特权的用户层次库:fork,exec,pipe,...</span><br><span class="line">  * 应用: 文件系统, shell, ..</span><br><span class="line">  * 开发环境: gcc, qemu</span><br><span class="line">  * lab 1 已经发放</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>(demo: build JOS and run ls)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(示例:构建JOS并且运行ls命令)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Xv6 and JOS<br>Two different designs<br>Hopefully will force you understand issues better, but will be confusing too<br>Neither has the complexity of a real OS<br>(demo: build Linux)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">* Xv6和JOS</span><br><span class="line">  两种不同的设计</span><br><span class="line">  希望能够促使你更好地理解问题,但是也会带来困惑</span><br><span class="line">  也不会有一个真正的操作系统的复杂</span><br><span class="line">  (示例: 构建Linux)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Two exams: midterm during class meeting, final in finals week</p>
</li>
</ul>
<p>Introduction to system calls<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">有关系统调用的介绍</span><br></pre></td></tr></table></figure></p>
<ul>
<li><p>6.828 is largely about design and implementation of system call<br>interface. let’s look at how programs use that interface.<br>we’ll focus on UNIX (Linux, Mac, POSIX, &amp;c).</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">* 6.828很大一部分是关于设计和实现系统调用接口. 让我们来看看程序是如何使用该接口的.</span><br><span class="line">我们将关注类UNIX系统(Linux, Mac, POSIX, 等等).</span><br></pre></td></tr></table></figure>
</li>
<li><p>a simple example: what system calls does “ls” call?</p>
<ul>
<li>Trace system calls:<ul>
<li>On OSX: sudo dtruss /bin/ls</li>
<li>On Linux: strace /bin/ls</li>
</ul>
</li>
<li>so many system calls!<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">* 一个简单的例子: &quot;ls&quot;调用了哪些系统调用?</span><br><span class="line">  * 追踪调用的系统调用</span><br><span class="line">    * 在OSX: sudo dtruss /bin/ls</span><br><span class="line">    * 在Linux: strace /bin/ls</span><br><span class="line">  * 太多太多系统调用了!</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>example: copy input to output<br>cat copy.c<br>cc -o copy copy.c<br>./copy<br>read a line, then write a line<br>note: written in C, the traditional O/S language</p>
<ul>
<li><p>first read/write argument is a “file descriptor” (fd)<br>passed to kernel to tell it what “open file” to read/write<br>must previously have been opened, connects to file/device/socket/&amp;c<br>UNIX convention: fd 0 is “standard input”, 1 is “standard output”  </p>
</li>
<li><p>sudo dtruss ./copy<br>read(0x0, “123\n\0”, 0x80)         = 4 0<br>write(0x1, “123\n@\213\002\0”, 0x4)         = 4 0</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">* 示例:将输入拷贝至输出</span><br><span class="line">  cat copy.c</span><br><span class="line">  cc -o copy copy.c</span><br><span class="line">  ./copy</span><br><span class="line">  读一行,然后写一行</span><br><span class="line">  注意:用编写传统操作系统的语言--C语言来编写</span><br><span class="line"></span><br><span class="line">  * 第一个 读/写 参数是一个&quot;文件描述元&quot;(fd)</span><br><span class="line">    传递给内核来告诉它是什么&quot;已打开的文件&quot;需要读/写操作</span><br><span class="line">    文件必须要提前已经被打开, 连接到file/device/socket/等等</span><br><span class="line">    UNIX约定: fd 0 是&quot;标准输入&quot;, 1 is &quot;标准输出&quot;</span><br><span class="line"></span><br><span class="line">  * sudo dtruss ./copy</span><br><span class="line">    read(0x0, &quot;123\n\0&quot;, 0x80)		 = 4 0</span><br><span class="line">    write(0x1, &quot;123\n@\213\002\0&quot;, 0x4)		 = 4 0</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>example: creating a file<br>cat open.c<br>cc -o open open.c<br>./open<br>cat output.txt<br>note: creat() turned into open()<br>note: can see actual FD with dtruss<br>note: this code ignores errors – don’t be this sloppy!</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">* 示例: 新建一个文件</span><br><span class="line">  cat open.c</span><br><span class="line">  cc -o open open.c</span><br><span class="line">  ./open</span><br><span class="line">  cat output.txt</span><br><span class="line">  注意: creat()变为了open()</span><br><span class="line">  注意: 可以通过dtruss查看到真实的FD</span><br><span class="line">  注意: 这段代码忽略了错误--可不能这么粗心!</span><br></pre></td></tr></table></figure>
</li>
<li><p>example: redirecting standard output<br>cat redirect.c<br>cc -o redirect redirect.c<br>./redirect<br>cat output.txt<br>man dup2<br>sudo dtruss ./redirect<br>note: writes output.txt via fd 1<br>note: stderr (standard error) is fd 2 – that’s why creat() yields FD 3</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">* 示例:重定向标准输出</span><br><span class="line">  cat redirect.c</span><br><span class="line">  cc -o redirect redirect.c</span><br><span class="line">  ./redirect</span><br><span class="line">  cat output.txt</span><br><span class="line">  man dup2</span><br><span class="line">  sudo dtruss ./redirect</span><br><span class="line">  注意: 通过fd 1写入output.txt</span><br><span class="line">  注意: stderr (标准错误) 是 fd 2 -- 这就是为什么 creat() 产生了 FD 3</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>a more interesting program: the Unix shell.</p>
<ul>
<li>it’s the Unix command-line user interface</li>
<li>it’s a good illustration of the UNIX system call API</li>
<li>some example commands:<br>ls<br>ls &gt; junk<br>ls | wc -l<br>ls | wc -l &gt; junk  </li>
<li>the shell is also a programming/scripting language<br>cat &gt; script<br>  &emsp;echo one<br>  &emsp;echo two<br>sh &lt; script</li>
<li>the shell uses system calls to set up redirection, pipes, waiting<br>programs like wc are ignorant of input/output setup<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">* 一个更有意思的程序: the Unix shell.</span><br><span class="line">  * 它是Unix系统的命令行用户接口</span><br><span class="line">  * 对于UNIX系统调用API,它是一个很好的举例</span><br><span class="line">  * 一些示例命令:</span><br><span class="line">    ls</span><br><span class="line">    ls &gt; junk</span><br><span class="line">    ls | wc -l</span><br><span class="line">    ls | wc -l &gt; junk</span><br><span class="line">  * shell还是一种程序/脚本语言</span><br><span class="line">    cat &gt; script</span><br><span class="line">      echo one</span><br><span class="line">      echo two</span><br><span class="line">    sh &lt; script</span><br><span class="line">  * shell使用系统调用来启动重定向, 管道, 等待</span><br><span class="line">    程序如wc对于输入/输出的启动是不知晓的</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>Let’s look at source for a simple shell, sh.c</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">让我们来看看一个简易的shell源代码文件,sh.c</span><br></pre></td></tr></table></figure>
<ul>
<li><p>main()<br>basic organization: parse into tree, then run<br>main process: getcmd, fork, wait<br>child process: parsecmd, runcmd<br>why the fork()?<br>  &emsp;we need a new process for the command<br>what does fork() do?<br>  &emsp;copies user memory<br>  &emsp;copies kernel state e.g. file descriptors<br>  &emsp;so “child” is almost identical to “parent”<br>  &emsp;child has different “process ID”<br>  &emsp;both processes now run, in parallel<br>  &emsp;fork returns twice, once in parent, once in child<br>  &emsp;fork returns child PID to parent<br>  &emsp;fork returns 0 to child<br>  &emsp;so sh calls runcmd() in the child process<br>why the wait()?<br>what if child exits before parent calls wait()?  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">* main()</span><br><span class="line">  basic organization: parse into tree, then run</span><br><span class="line">  main process: getcmd, fork, wait</span><br><span class="line">  child process: parsecmd, runcmd </span><br><span class="line">  why the fork()?</span><br><span class="line">    we need a new process for the command</span><br><span class="line">  what does fork() do?</span><br><span class="line">    copies user memory</span><br><span class="line">    copies kernel state e.g. file descriptors</span><br><span class="line">    so &quot;child&quot; is almost identical to &quot;parent&quot;</span><br><span class="line">    child has different &quot;process ID&quot;</span><br><span class="line">    both processes now run, in parallel</span><br><span class="line">    fork returns twice, once in parent, once in child</span><br><span class="line">    fork returns child PID to parent</span><br><span class="line">    fork returns 0 to child</span><br><span class="line">    so sh calls runcmd() in the child process</span><br><span class="line">  why the wait()?</span><br><span class="line">  what if child exits before parent calls wait()?</span><br></pre></td></tr></table></figure>
</li>
<li><p>runcmd()<br>executes parse tree generated by parsecmd()<br>distinct cmd types for simple command, redirection,<br>pipe</p>
</li>
<li><p>runcmd() for simple command with arguments<br>execvp(cmd, args)<br>man execvp<br>ls command &amp;c exist as executable files, e.g. /bin/ls<br>execvp loads executable file over memory of current process<br>jumps to start of executable – main()<br>note: execvp doesn’t return if all goes well<br>note: execvp() only returns if it can’t find the executable file<br>note: it’s the shell child that’s replaced with execvp()<br>note: the main shell process is still wait()ing for the child  </p>
</li>
<li><p>how does runcmd() handle I/O redirection?<br>e.g. echo hello &gt; junk<br>parsecmd() produces tree with two nodes<br>  &emsp;cmd-&gt;type=’&gt;’, cmd-&gt;file=”junk”, cmd-&gt;cmd=…<br>  &emsp;cmd-&gt;type=’ ‘, cmd-&gt;argv=[“echo”, “hello”]<br>the open(); dup2() causes FD 1 to be replaced with FD to output file<br>it’s the shell child process that changes its FD 1<br>execvp preserves the FD setup<br>so echo runs with FD 1 connected to file junk<br>again, very nice that echo is oblivious, just writes FD 1  </p>
</li>
<li><p>why are fork and exec separate?<br>perhaps wasteful that fork copies shell memory, only<br>  to have it thrown away by exec<br>the point: the child gets a chance to change FD setup<br>  before calling exec<br>and the parent’s FD set is not disturbed<br>you’ll implement tricks to avoid fork() copy cost in the labs</p>
</li>
<li><p>how does the shell implement pipelines?<br>$ ls | wc -l</p>
</li>
<li><p>the kernel provides a pipe abstraction<br>int fds[2]<br>pipe(fds)<br>a pair of file descriptors: a write FD, and a read FD<br>data written to the write FD appears on the read FD  </p>
</li>
<li><p>example: pipe1.c<br>read() blocks until data is available<br>write() blocks if pipe buffer is full</p>
</li>
<li><p>pipe file descriptors are inherited across fork<br>so pipes can be used to communicate between processes<br>example: pipe2.c<br>for many programs, just like file I/O, so pipes work for stdin/stdout</p>
</li>
<li><p>for ls | wc -l, shell must:</p>
<ul>
<li>create a pipe</li>
<li>fork</li>
<li>set up fd 1 to be the pipe write FD</li>
<li>exec ls</li>
<li>set up wc’s fd 0 to be pipe read FD</li>
<li>exec wc</li>
<li>wait for wc<br>[diagram: sh parent, sh child, ls grandchild, wc grandchild, stdin/out for each]<br>case ‘|’ in sh.c<br>note: sh close()es unused FDs  <pre><code>&amp;emsp;so exit of writer produces EOF at reader
</code></pre></li>
</ul>
</li>
<li><p>you’ll implement pieces of a shell in an upcoming homework</p>
</li>
</ul>
</li>
</ul>

        </div>

        <blockquote class="post-copyright">
    
    <div class="content">
        
<span class="post-time">
    最后更新时间：<time datetime="2019-09-07T05:20:46.738Z" itemprop="dateUpdated">2019-09-07 05:20:46</time>
</span><br>


        
        这里可以写作者留言，标签和 hexo 中所有变量及辅助函数等均可调用，示例:<a href="/2019/02/18/6-828-2018-Lecture-1-O-S-overview/" target="_blank" rel="external">http://andj.me/2019/02/18/6-828-2018-Lecture-1-O-S-overview/</a>
        
    </div>
    
    <footer>
        <a href="http://andj.me">
            <img src="/img/AnDJ.png" alt="AnDJ">
            AnDJ
        </a>
    </footer>
</blockquote>

        
<div class="page-reward">
    <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-circle waves-light">赏</a>
</div>



        <div class="post-footer">
            

            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://andj.me/2019/02/18/6-828-2018-Lecture-1-O-S-overview/&title=《6.828-2018-Lecture-1:O/S overview》 — 泡壶Java&pic=http://andj.me/img/AnDJ.png" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://andj.me/2019/02/18/6-828-2018-Lecture-1-O-S-overview/&title=《6.828-2018-Lecture-1:O/S overview》 — 泡壶Java&source=写一写-from AnDJ" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://andj.me/2019/02/18/6-828-2018-Lecture-1-O-S-overview/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《6.828-2018-Lecture-1:O/S overview》 — 泡壶Java&url=http://andj.me/2019/02/18/6-828-2018-Lecture-1-O-S-overview/&via=http://andj.me" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=http://andj.me/2019/02/18/6-828-2018-Lecture-1-O-S-overview/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="waves-block waves-effect prev">
      <a href="/2019/09/07/hello-world/" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">Hello World</h4>
      </a>
    </div>
  

  
    <div class="waves-block waves-effect next">
      <a href="/2019/01/20/Assignment-for-Stanford-cs143-Compilers/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">Assignment for Stanford CS143:Compilers</h4>
      </a>
    </div>
  
</nav>



    








<section class="comments" id="comments">
    <div id="gitment_thread"></div>
    <link rel="stylesheet" href="//unpkg.com/gitment/style/default.css">
    <script src="//unpkg.com/gitment/dist/gitment.browser.js"></script>
    <script>
        var gitment = new Gitment({
            owner: 'An-DJ',
            repo: 'An-DJ.github.io',
            oauth: {
                client_id: '106f8afcaab37f3556a1',
                client_secret: 'bf0356de07c66f7fee01e53f673489ab7242d4ca',
            },
        })
        gitment.render('comments')
    </script>
</section>







</article>

<div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        多谢捧场~
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardCode" src="/img/wechat.png" alt="打赏二维码">
        </div>
        
        <label class="reward-toggle">
            <input id="rewardToggle" type="checkbox" class="reward-toggle-check" data-wechat="/img/wechat.png" data-alipay="/img/alipay.png">
            <div class="reward-toggle-ctrol">
                <span class="reward-toggle-item wechat">微信</span>
                <span class="reward-toggle-label"></span>
                <span class="reward-toggle-item alipay">支付宝</span>
            </div>
        </label>
        
    </div>
</div>



</div>

        <footer class="footer">
    <div class="top">
        
<p>
    <span id="busuanzi_container_site_uv" style="display:none">
        站点总访客数<span id="busuanzi_value_site_uv"></span>
    </span>
    <span id="busuanzi_container_site_pv" style="display:none">
        站点总访问量<span id="busuanzi_value_site_pv"></span>
    </span>
</p>


        <p>
            
                <span><a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-lg icon-rss"></i></a></span>
            
            <span>博客内容遵循 <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a></span>
        </p>
    </div>
    <div class="bottom">
        <p><span>AnDJ &copy; 2015 - 2019</span>
            <span>
                
                <a href="http://www.miitbeian.gov.cn/" target="_blank">晋ICP备17005941号</a><br>
                
                Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a>
            </span>
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://andj.me/2019/02/18/6-828-2018-Lecture-1-O-S-overview/&title=《6.828-2018-Lecture-1:O/S overview》 — 泡壶Java&pic=http://andj.me/img/AnDJ.png" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://andj.me/2019/02/18/6-828-2018-Lecture-1-O-S-overview/&title=《6.828-2018-Lecture-1:O/S overview》 — 泡壶Java&source=写一写-from AnDJ" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://andj.me/2019/02/18/6-828-2018-Lecture-1-O-S-overview/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《6.828-2018-Lecture-1:O/S overview》 — 泡壶Java&url=http://andj.me/2019/02/18/6-828-2018-Lecture-1-O-S-overview/&via=http://andj.me" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=http://andj.me/2019/02/18/6-828-2018-Lecture-1-O-S-overview/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACLUlEQVR42u3aS27jQAwFwNz/0h5gVgEykh9JKRhT1SsjseWuXtD89NdXvF5/1/fX3/9y9P6f6+i/+ZNHCwMD42MZr9P1k3EEywFHz8yf9o/PYmBgPIAxCbJ5eL2DioGBgZG8p7r186PBwMDAuCrgJl+fpI/JcWBgYGDkRWzvPefsHHxZLY6BgfGBjN5g4Hde3z7fwMDA+O8Zr+LKi9g7mneHu8LAwFjNSMrR3thyvvW8eMbAwNjNyB/dSxmrrf98eICBgfFMRrLd6oZ61zLyihUDA+MJjF5ylieRvWSxd1EMAwNjKyNvwV8bTPNGXnRAGBgYqxm9EJm36vKEMm+xFVpvGBgYKxj5FueXxuYp6ZtJLAYGxmrGeRmZDwbyI6je9XoTpjEwMFYzqj25aqpXLVYnw04MDIzdjPNHVFv5vZK1WiSX77hhYGCsY8wHk/m28lSyHHAxMDBWMJKLWYW216VFaSHUYmBgrGZUW2NJKKwmkb1mX/SLgYGBsYjRqwTzpHCeSiYHh4GBsZVRVU6q5Oq5FoagGBgYD2Dkxeqk0J38Drz5FAYGxmpGNVErl5G3XRdrZqkYGBgfyHgVV/ULJtRCiomBgbGa0QuU1QHABF8dc2JgYGxlJEE2+bLRrbR5Uw8DA+MBjPsKzqtiPwYGBsZVVy7yJyQhuzBIwMDAwBi0vXJMb0SKgYHxHEYS4PK2WnLNIjmIQiMPAwNjNaNXQFZHlb3QXD1WDAyMdYw//iRBz/oZc24AAAAASUVORK5CYII=" alt="微信分享二维码">
</div>




    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: true };


</script>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/main.min.js"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/search.min.js" async></script>






<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>



<script>
(function() {
    var OriginTitile = document.title, titleTime;
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            document.title = 'leave';
            clearTimeout(titleTime);
        } else {
            document.title = 'back';
            titleTime = setTimeout(function() {
                document.title = OriginTitile;
            },2000);
        }
    });
})();
</script>



</body>
</html>
